<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ê∏≠ÂüéÊõ≤ÔºöÈÄÅÂÖÉ‰∫å‰ΩøÂÆâË•ø</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      body {
        font-family: 'Noto Serif TC', serif;
        background-color: #1a1a1a;
        margin: 0;
        overflow: hidden;
      }
      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: rgba(0,0,0,0.1);
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(255,255,255,0.2);
        border-radius: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: rgba(234, 179, 8, 0.3);
        border-radius: 3px;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .animate-fade-in {
        animation: fadeIn 0.5s ease-out forwards;
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      // ==========================================
      // TYPES & ENUMS (Simulated for JS)
      // ==========================================
      const CharacterId = {
        WangWei: 'wangwei',
        YuanEr: 'yuaner',
        Player: 'player',
        Narrator: 'narrator',
        XiaoMing: 'xiaoming'
      };

      // ==========================================
      // CONSTANTS (Story Script & Assets)
      // ==========================================
      
      // ËÉåÊôØÂúñÁâáË≥áÊ∫ê
      const BG_RAINY_CITY = '/bg_rain.jpg'; 
      const BG_Desert = 'https://images.unsplash.com/photo-1547235001-d703406d3f17?q=80&w=1748&auto=format&fit=crop'; 
      const BG_home = 'https://images.unsplash.com/photo-1561900077-7cb929361d51?q=80&w=1740&auto=format&fit=crop';
      const BG_INN_WILLOW = './image/bg_willow.jpg'; 
      const BG_INN_INTERIOR = '/bg_inn.jpg';
      const BG_BAD_ENDING = '/bg_bad.jpg';
      const BG_GOOD_ENDING = '/bg_good.jpg';
      const BG_POEM_SCROLL = '/bg_poem.jpg';
      const BG_CLASSROOM = 'https://images.unsplash.com/photo-1580582932707-520aed937b7b?q=80&w=1932&auto=format&fit=crop'; 

      const CHARACTERS = {
        [CharacterId.WangWei]: {
          id: CharacterId.WangWei,
          name: 'ÁéãÁ∂≠',
          avatarUrl: '/wangwei.png' 
        },
        [CharacterId.YuanEr]: {
          id: CharacterId.YuanEr,
          name: 'ÂÖÉ‰∫å',
          avatarUrl: '/yuaner.png' 
        },
        [CharacterId.Player]: {
          id: CharacterId.Player,
          name: 'ÁéãÁ∂≠',
          avatarUrl: ''
        },
        [CharacterId.Narrator]: {
          id: CharacterId.Narrator,
          name: '',
          avatarUrl: ''
        },
        [CharacterId.XiaoMing]: {
          id: CharacterId.XiaoMing,
          name: 'Â∞èÊòé',
          avatarUrl: 'https://api.dicebear.com/9.x/micah/svg?seed=XiaoMing&backgroundColor=b6e3f4' 
        }
      };

      const STORY_SCRIPT = {
        'start': {
          id: 'start',
          backgroundUrl: BG_RAINY_CITY,
          characterId: CharacterId.Narrator,
          text: '„ÄêÂ∫èÁ´†ÔºöÈõ®Êô®„Äë\n\n‰Ω†ÊâÆÊºîÂîê‰ª£Ë©©‰∫∫ÁéãÁ∂≠„ÄÇÈÅéÂπæÂ§©ÔºåÊòØ‰Ω†ÈÄÅÂà•ÊëØÂèãÂÖÉ‰∫åÁöÑÊó•Â≠ê„ÄÇ',
          choices: [
            { id: 'start_act1', text: 'ÈñãÂßãÊïÖ‰∫ã', nextSceneId: 'intro_quiz_destination', isGrowthMindset: false }
          ],
          specialEffect: 'rain'
        },
        'intro_quiz_destination': {
          id: 'intro_quiz_destination',
          backgroundUrl: BG_home,
          characterId: CharacterId.WangWei,
          text: 'ÔºàÊàëÊâãË£°ÊãøËëóÂÖÉ‰∫åÁöÑ‰ø°...Ôºâ\n\nÂÖÉ‰∫åË¢´Áöá‰∏äÊ¥æÂéªÂü∑Ë°å‰ªªÂãôÔºåÈÄôÊòØ‰∏Ä‰ªΩÊ¶ÆËÄÄÔºå‰ΩÜ‰πüÂÖÖÊªøÊåëÊà∞„ÄÇ\n‰ªñË¶ÅÂéªÂì™Ë£°‰ªªËÅ∑Âë¢Ôºü',
          choices: [
            { id: 'q_dest_right', text: 'ÂéªË•øÈÇäÁöÑ„ÄåÂÆâË•øÈÉΩË≠∑Â∫ú„Äç', nextSceneId: 'intro_dest_right', isGrowthMindset: false },
            { id: 'q_dest_wrong', text: 'ÂéªÂçóÈÇäÁöÑ„ÄåÁÖôÈõ®Ê±üÂçó„Äç', nextSceneId: 'intro_dest_wrong', isGrowthMindset: false }
          ],
        },
        'intro_dest_wrong': {
          id: 'intro_dest_wrong',
          backgroundUrl: BG_Desert,
          characterId: CharacterId.WangWei,
          text: '‰∏çÂ∞çÂñî„ÄÇ‰ø°‰∏äÂØ´ÁöÑÊòØÂéªË•øÂüüÈÇäÁñÜÔºå‰øùË≠∑Áµ≤Á∂¢‰πãË∑ØÁöÑÂÆâÂÖ®„ÄÇÈÇ£Ë£°ÂèØÊòØÊ≤ôÊº†ÈÅçÂ∏ÉÁöÑÂú∞Êñπ„ÄÇ',
          choices: [
            { id: 'retry_dest', text: 'ÂÜçÊÉ≥‰∏ÄÊÉ≥', nextSceneId: 'intro_quiz_destination', isGrowthMindset: false }
          ],
        },
        'intro_dest_right': {
          id: 'intro_dest_right',
          backgroundUrl: BG_Desert,
          characterId: CharacterId.WangWei,
          text: 'Ê≤íÈåØÔºåÂ∞±ÊòØÂÆâË•ø„ÄÇÈÇ£Ë£°Èõ¢Èï∑ÂÆâÔºàË•øÂÆâÔºâÊúâÂπæÂçÉÈáåÈÅ†Ôºå‰∏≠ÈñìÈöîËëóÂ§ßÊ≤ôÊº†„ÄÇ\nÈÄô‰∏ÄÂéªÔºå‰∏çÁü•‰ΩïÂπ¥‰ΩïÊúàÊâçËÉΩÂÜçË¶ãÈù¢„ÄÇ',
          choices: [
            { id: 'next_quiz_loc', text: 'ÊÄùËÄÉÈÄÅÂà•Âú∞Èªû...', nextSceneId: 'intro_quiz_location', isGrowthMindset: false }
          ],
        },
        'intro_quiz_location': {
          id: 'intro_quiz_location',
          backgroundUrl: BG_RAINY_CITY,
          characterId: CharacterId.WangWei,
          text: 'Êó¢ÁÑ∂‰ªñË¶ÅÂæÄË•øËµ∞ÔºåÊàëÊáâË©≤Âú®Âì™Ë£°ÁÇ∫‰ªñÈÄÅË°åÔºåÊâçËÉΩË°®ÈÅîÊàëÊúÄÂ§ßÁöÑÂøÉÊÑèÂë¢Ôºü',
          choices: [
            { id: 'q_loc_right', text: 'Âéª„ÄåÊ∏≠Âüé„ÄçÔºàÂí∏ÈôΩÔºâÔºåÈÇ£ÊòØË•øË°åÁöÑËµ∑Èªû', nextSceneId: 'intro_loc_right', isGrowthMindset: false },
            { id: 'q_loc_wrong', text: 'Â∞±Âú®ÊàëÂÆ∂ÈñÄÂè£ÊèÆÊèÆÊâãÂ∞±Â•Ω', nextSceneId: 'intro_loc_wrong', isGrowthMindset: false }
          ],
          specialEffect: 'rain'
        },
        'intro_loc_wrong': {
          id: 'intro_loc_wrong',
          backgroundUrl: BG_RAINY_CITY,
          characterId: CharacterId.WangWei,
          text: 'ÈÄôÂèØÊòØÂéªÂÆâË•øÂïäÔºÅÂè™Âú®ÈñÄÂè£ÈÄÅÂà•Â§™Èö®‰æø‰∫Ü„ÄÇ‰∫∫ÂÄëÈÄÅÂà•Ë•øË°åÁöÑÊúãÂèãÔºåÈÄöÂ∏∏ÈÉΩÊúÉÈÄÅÂà∞ÂüéÂ§ñÂæàÈÅ†ÁöÑÊ∏≠Âüé„ÄÇ',
          choices: [
            { id: 'retry_loc', text: 'ÈáçÊñ∞Ê±∫ÂÆö', nextSceneId: 'intro_quiz_location', isGrowthMindset: false }
          ],
          specialEffect: 'rain'
        },
        'intro_loc_right': {
          id: 'intro_loc_right',
          backgroundUrl: BG_RAINY_CITY,
          characterId: CharacterId.WangWei,
          text: 'Â∞çÔºÅÊ∏≠ÂüéÊòØÈï∑ÂÆâÂæÄË•øËµ∞ÁöÑÂøÖÁ∂ì‰πãË∑Ø„ÄÇÂá∫‰∫ÜÊ∏≠ÂüéÔºåÂ∞±ÊòØËçíÊ∂ºÁöÑÂ°ûÂ§ñ‰∫Ü„ÄÇ\n\nÊàëÊòéÊó©Â∞±Ë∂ïÂà∞‰∫ÜÂÆ¢Ê£ßÁ≠â‰ªñ„ÄÇ',
          choices: [
            { id: 'enter_inn', text: 'Ëµ∞ÈÄ≤ÂÆ¢Ê£ßÊàøÈñì', nextSceneId: 'act1_dialogue_1', isGrowthMindset: false }
          ],
          specialEffect: 'rain'
        },
        'act1_dialogue_1': {
          id: 'act1_dialogue_1',
          backgroundUrl: BG_INN_INTERIOR,
          characterId: CharacterId.YuanEr,
          text: 'ÔºàÊï¥ÁêÜËëóË°åÂõäÔºåËΩâÈÅéË∫´‰æÜÔºâ\nÁéãÁ∂≠ÂÖÑÔºåÊôÇÂÄô‰∏çÊó©‰∫ÜÔºåÊàëÂ∞±Ë¶ÅÂá∫ÁôºÂéªÂÆâË•ø‰∫Ü„ÄÇ',
          choices: [
            { id: 'c1_reply', text: 'ÂõûÊáâÂÖÉ‰∫å', nextSceneId: 'act1_dialogue_2', isGrowthMindset: false }
          ],
          specialEffect: 'rain'
        },
        'act1_dialogue_2': {
          id: 'act1_dialogue_2',
          backgroundUrl: BG_RAINY_CITY,
          characterId: CharacterId.WangWei,
          text: 'ÊàëÁü•ÈÅì„ÄÇË∑ØÈÄîÈÅôÈÅ†ÂèàÂç±Èö™Ôºå‰Ω†Ë¶ÅÂ§öÂ§ö‰øùÈáçÂïä„ÄÇ',
          choices: [
            { id: 'c2_next', text: 'ËÅΩÂÖÉ‰∫åË™™...', nextSceneId: 'act1_location_quiz', isGrowthMindset: false }
          ],
          specialEffect: 'rain'
        },
        'act1_location_quiz': {
          id: 'act1_location_quiz',
          backgroundUrl: BG_RAINY_CITY,
          characterId: CharacterId.YuanEr,
          text: 'Â§öË¨ùÁéãÁ∂≠ÂÖÑÁâπÂú∞ÈÄÅÂà∞ÈÄôË£°„ÄÇÊ∏≠ÂüéÔºàÂí∏ÈôΩÔºâÈõ¢Èï∑ÂÆâÔºàË•øÂÆâÔºâ‰πü‰∏çËøë„ÄÇ‰Ω†Áà≤‰ªÄÈ∫ºË¶ÅÈÄÅÊàëÂà∞Ê∏≠ÂüéÂë¢Ôºü',
          choices: [
            { 
              id: 'q1_right', 
              text: 'ÈÄôË£°ÊòØÂæÄË•øËµ∞ÁöÑËµ∑ÈªûÔºåÂá∫‰∫ÜÈÄôË£°ÔºåÂ∞±Ë¶ÅÈõ¢ÈñãÊàëÂÄëÁÜüÊÇâÁöÑ‰∏≠Âéü‰∫Ü„ÄÇ', 
              nextSceneId: 'act1_location_right', 
              isGrowthMindset: false
            },
            { 
              id: 'q1_wrong', 
              text: 'Ê∏≠ÂüéÈ¢®ÊôØÂÑ™ÁæéÔºåÊàëÈ†ÜË∑ØÈÅé‰æÜÁúãÁúã„ÄÇ', 
              nextSceneId: 'act1_location_wrong', 
              isGrowthMindset: false 
            }
          ],
          specialEffect: 'rain'
        },
        'act1_location_wrong': {
          id: 'act1_location_wrong',
          backgroundUrl: BG_RAINY_CITY,
          characterId: CharacterId.YuanEr,
          text: 'ÔºàÊÑ£‰∫Ü‰∏Ä‰∏ãÔºâÂëÉ... ÊàëÁúãÂë®ÂúçÂæàÂ§öÈÄÅÂà•ÁöÑ‰∫∫ÔºåÈÄôË£èÊáâË©≤ÊòØ‰∫∫ÂÄëÁøíÊÖ£ÊúÄÂæåÈÄÅÂà•ÁöÑÂú∞ÊñπÂêß„ÄÇ',
          choices: [
            { id: 'q1_retry', text: 'Â•ΩÂÉèÊòØÂñî', nextSceneId: 'act1_location_right', isGrowthMindset: false }
          ],
          specialEffect: 'rain'
        },
        'act1_location_right': {
          id: 'act1_location_right',
          backgroundUrl: BG_RAINY_CITY,
          characterId: CharacterId.YuanEr,
          text: 'ÔºàÊúâ‰∫õÊÑüÂÇ∑ÔºâÂá∫‰∫ÜÈôΩÈóúÔºåÂæÄË•øËµ∞Â∞±ÁúüÁöÑÊòØÂÆåÂÖ®ÈôåÁîüÁöÑ‰∏ñÁïå‰∫Ü„ÄÇ',
          choices: [
            { id: 'to_scenery', text: 'ÁúãÂêëÁ™óÂ§ñ', nextSceneId: 'act1_scenery_observe', isGrowthMindset: false }
          ],
          specialEffect: 'rain'
        },
        'act1_scenery_observe': {
          id: 'act1_scenery_observe',
          backgroundUrl: BG_INN_WILLOW,
          characterId: CharacterId.WangWei,
          text: 'Ôºà‰Ω†ÁúãÂêëÁ™óÂ§ñÔºâ\nÁúãÔºå‰ªäÂ§©Êó©‰∏äÁöÑÈõ®ÊääË∑Ø‰∏äÁöÑÁÅ∞Â°µÈÉΩÊ¥ó‰πæÊ∑®‰∫ÜÔºàÊµ•ËºïÂ°µÔºâÔºåÂÆ¢Ê£ßÊóÅÈÇäÁöÑÊü≥Ê®πÁ∂ìÈÅéÈõ®Ê∞¥Ê≤ñÊ¥óÔºåÈ°èËâ≤ÁúãËµ∑‰æÜÁâπÂà•Ê∏ÖÊñ∞ÔºàÊü≥Ëâ≤Êñ∞Ôºâ„ÄÇ',
          choices: [
            { id: 'scenery_reply', text: 'Á≠âÂæÖÂÖÉ‰∫åÂõûÊáâ', nextSceneId: 'act1_scenery_quiz', isGrowthMindset: false }
          ]
        },
        'act1_scenery_quiz': {
          id: 'act1_scenery_quiz',
          backgroundUrl: BG_INN_WILLOW,
          characterId: CharacterId.YuanEr,
          text: 'ÈÄôÊü≥Ê®πÁúüÁ∂†Âïä... ËÆìÊàëÊÉ≥Ëµ∑‰ª•ÂâçÊàëÂÄëÂú®Èï∑ÂÆâÁöÑÊó•Â≠ê„ÄÇÁéãÁ∂≠ÂÖÑÔºå‰Ω†ÁúãÈÄôÊôØËâ≤ÊÄéÈ∫ºÊ®£Ôºü',
          choices: [
            { 
              id: 'q2_wrong', 
              text: '‰∏ãÈõ®Â§©Âà∞ËôïÊøïÁ≠îÁ≠îÁöÑÔºåË∏©ÂæóÊªøËÖ≥Ê≥•ÔºåÁúüÈ∫ªÁÖ©„ÄÇ', 
              nextSceneId: 'act1_scenery_wrong', 
              isGrowthMindset: false 
            },
            { 
              id: 'q2_right', 
              text: 'ÈÄôÊôØËâ≤ÂæàÁæéÔºå‰ΩÜ‰πüËÆìÊàëË¶∫ÂæóÊõ¥Âä†Êç®‰∏çÂæó‰Ω†„ÄÇÊü≥Ê®πÈùíÈùíÔºåÂÉèÊòØÂú®ÊåΩÁïô‰Ω†‰∏ÄÊ®£„ÄÇ', 
              nextSceneId: 'act1_scenery_right', 
              isGrowthMindset: false 
            }
          ]
        },
        'act1_scenery_wrong': {
          id: 'act1_scenery_wrong',
          backgroundUrl: BG_INN_WILLOW,
          characterId: CharacterId.YuanEr,
          text: 'ÈÄô... ÊàëÂÄëÂç≥Â∞áÂàÜÂà•ÔºåÁéãÁ∂≠ÂÖÑÊÄéÈ∫ºÂè™Âú®ÊÑèËÖ≥‰∏ãÁöÑÊ≥•ÂúüÂë¢Ôºü',
          choices: [
            { id: 'q2_retry', text: 'ÈáçÊñ∞ËßÄÂØü‰∏¶Ë°®ÈÅîÊÉÖÊÑü', nextSceneId: 'act1_scenery_quiz', isGrowthMindset: false }
          ]
        },
        'act1_scenery_right': {
          id: 'act1_scenery_right',
          backgroundUrl: BG_INN_WILLOW,
          characterId: CharacterId.YuanEr,
          text: 'ÔºàÊÑüÂãïÂú∞ÁúãËëó‰Ω†ÔºâÁü•ÊàëËÄÖÔºåÁéãÁ∂≠ÂÖÑ‰πü„ÄÇÈÄôÈ¢®ÊôØÔºåËÆìÊàëÊõ¥Êç®‰∏çÂæóÈõ¢ÈñãÂïä„ÄÇÂîâÔºÅ',
          choices: [
            { id: 'prologue_done', text: 'Èö®ÂæûÂÇ¨‰øÉÂá∫Áôº...', nextSceneId: 'prologue_end', isGrowthMindset: false }
          ]
        },
        'prologue_end': {
          id: 'prologue_end',
          backgroundUrl: BG_INN_INTERIOR,
          characterId: CharacterId.Narrator,
          text: '„Äêüéâ Â∫èÁ´†Â∑≤ÈÄöÈóú„Äë\n‰Ω†Â∑≤Á∂ìÂõûÈ°ß‰∫ÜÈÄÅÂà•ÁöÑËÉåÊôØËàáÊôØÁâ©Ôºö\n„ÄåÊ∏≠ÂüéÊúùÈõ®Êµ•ËºïÂ°µÔºåÂÆ¢ËàçÈùíÈùíÊü≥Ëâ≤Êñ∞„Äç\n\nÊúÄÂæåÁöÑÊôÇÂàªÂà∞‰∫ÜÔºåÁéãÁ∂≠ÊúÉÂ∞çÂÖÉ‰∫åË™™‰ªÄÈ∫ºÂë¢Ôºü\nÔºàË´ãÂÖàÊö´ÂÅúÈÅäÊà≤ÔºåÁ≠âÂæÖËÄÅÂ∏´Ë¨õË™≤Ôºâ',
          choices: [
            { id: 'pause_game', text: 'ÁπºÁ∫åÈÅäÊà≤', nextSceneId: 'act2_intro', isGrowthMindset: false }
          ],
          specialEffect: 'gold_glow'
        },
        'act2_intro': {
          id: 'act2_intro',
          backgroundUrl: BG_INN_INTERIOR,
          characterId: CharacterId.Narrator,
          text: '„ÄêÁµÇÁ´†ÔºöÊúÄÂæåÁöÑÊäâÊìá„Äë\nË™≤Â†ÇÁπºÁ∫å„ÄÇ\nÂÖÉ‰∫åÂ∑≤Á∂ìÁ´ôËµ∑Ë∫´ÔºåÈ¶¨ËªäÂ∞±Âú®ÈñÄÂ§ñÁ≠âÂÄô„ÄÇÈÄôÊòØÊúÄÂæåË™™Ë©±ÁöÑÊ©üÊúÉ‰∫Ü„ÄÇ',
          choices: [
            { id: 'continue_act2', text: 'ÂõûÂà∞ÂÆ¢Ê£ß', nextSceneId: 'act2_dialogue_1', isGrowthMindset: false }
          ]
        },
        'act2_dialogue_1': {
          id: 'act2_dialogue_1',
          backgroundUrl: BG_INN_INTERIOR,
          characterId: CharacterId.YuanEr,
          text: 'ÁéãÁ∂≠ÂÖÑÔºåÈÖíÂ∑≤Âñù‰πæÔºåÊàëË©≤Ëµ∞‰∫Ü„ÄÇÈÄô‰∏ÄÂéªÔºå‰∏çÁü•‰ΩïÂπ¥‰ΩïÊúàÊâçËÉΩÂÜçË¶ã...',
          choices: [
            { id: 'c3_pour_wine', text: 'Á´ØËµ∑ÈÖíÂ£∫ÔºåÂÄíÊªøÊúÄÂæå‰∏ÄÊùØÈÖí', nextSceneId: 'act2_core_choice', isGrowthMindset: false }
          ]
        },
        'act2_core_choice': {
          id: 'act2_core_choice',
          backgroundUrl: BG_INN_INTERIOR,
          characterId: CharacterId.WangWei,
          text: 'Ôºà‰Ω†ÁúãËëóÊªøÊùØÁöÑÈÖíÔºåÂøÉË£°‰∫îÂë≥ÈõúÈô≥„ÄÇ‰ΩúÁÇ∫Â•ΩÊúãÂèãÔºåÈÄôÊúÄÂæå‰∏ÄÂè•Ë©±Ë©≤Ë™™‰ªÄÈ∫ºÔºüÔºâ',
          choices: [
            { 
              id: 'choice_fixed', 
              text: 'ÈÄô‰∏ÄÂÆöÊòØÊúÄÂæå‰∏ÄÊùØ‰∫Ü... ‰Ω†Ëµ∞‰∫ÜÂ∞±ÊòØÊ∞∏Âà•‰∫Ü„ÄÇ‰ª•ÂæåÂÜç‰πüÊ≤í‰∫∫Èô™ÊàëÂñùÈÖí‰∫Ü„ÄÇ', 
              nextSceneId: 'bad_ending', 
              isGrowthMindset: false 
            },
            { 
              id: 'choice_growth', 
              text: '‰æÜÔºÅÁÇ∫‰∫ÜÊàëÂÄëÁöÑÂèãË™ºÔºåÂÜç‰πæ‰∏ÄÊùØÂêßÔºÅÈõñÁÑ∂ÊàëÂÄëÊúÉÂàÜÈñãÔºå‰ΩÜÊàëÁöÑÂøÉÈô™‰Ω†‰∏ÄËµ∑ÂéªÂÆâË•ø„ÄÇÁ•ù‰Ω†Âª∫ÂäüÁ´ãÊ•≠ÔºÅ', 
              nextSceneId: 'good_ending', 
              isGrowthMindset: true 
            }
          ]
        },
        'bad_ending': {
          id: 'bad_ending',
          backgroundUrl: BG_BAD_ENDING,
          characterId: CharacterId.Narrator,
          text: '„ÄêÁµêÂ±ÄÔºöÁõ∏ÂøòÊñºÊ±üÊπñ„Äë\nÂÖÉ‰∫åËÅΩ‰∫Ü‰Ω†ÁöÑË©±ÔºåÂ∏∂ËëóÊ≤âÈáçÁöÑÂøÉÊÉÖÈõ¢Èñã‰∫Ü„ÄÇ\n\nË∑ØÈÄîÈÅôÈÅ†ÔºåÂõ†ÁÇ∫Èõ¢Âà•ÊôÇÂ§™ÈÅéÂÇ∑ÊÑüÔºåÂÖ©‰∫∫ÈÉΩË¶∫ÂæóÈÄôÊÆµÂèãË™ºÂÖÖÊªø‰∫ÜÁóõËã¶„ÄÇÊº∏Êº∏Âú∞ÔºåËÅØÁπ´Ë∂ä‰æÜË∂äÂ∞ë„ÄÇ\nÂú®ÈÅôÈÅ†ÁöÑÂÆâË•øÔºåÂÖÉ‰∫åÂ∏∏Â∏∏ÊÑüÂà∞Â≠§Áç®ÔºõËÄåÁéãÁ∂≠‰πüÂ§±Âéª‰∫Ü‰∏Ä‰ΩçÊúÄÂ•ΩÁöÑÊúãÂèã„ÄÇ',
          choices: [
              { id: 'read_poem_bad', text: 'ÂõûÂë≥ÈÄôÈ¶ñË©©', nextSceneId: 'poem_display_final', isGrowthMindset: false }
          ], 
          specialEffect: 'fade_black'
        },
        'good_ending': {
          id: 'good_ending',
          backgroundUrl: BG_GOOD_ENDING,
          characterId: CharacterId.Narrator,
          text: '„ÄêÁµêÂ±ÄÔºöÂ§©Ê∂ØËã•ÊØîÈÑ∞„Äë\nÂÖÉ‰∫åËÅΩ‰∫Ü‰Ω†ÁöÑË©±ÔºåÊÑüÂãïÂú∞Âñù‰∏ãÈÄôÊùØÈÖíÔºåÂ∏∂ËëóÊªøÊªøÁöÑÂãáÊ∞£Ë∏è‰∏ä‰∫ÜÊóÖÁ®ãÔºÅ\n\nÈõñÁÑ∂Áõ∏ÈöîËê¨ÈáåÔºå‰ΩÜ‰Ω†ÂÄëÁ∂ìÂ∏∏ÂØ´‰ø°ÂàÜ‰∫´ÁîüÊ¥ª„ÄÇÂÖÉ‰∫åÂú®ÂÆâË•øÂä™ÂäõÂ∑•‰Ωú„ÄÇ\n‰Ω†ÂÄëÁöÑÂèãË™ºÔºåÂõ†ÁÇ∫ÈÄô‰ªΩÁ•ùÁ¶èÔºåËÆäÂæóÊõ¥Ê∑±Âéö„ÄÅÊõ¥Áâ¢Âõ∫‰∫Ü„ÄÇ',
          choices: [
              { id: 'read_poem_good', text: 'ÂêüË™¶ÈÄôÈ¶ñÂçÉÂè§ÂêçË©©', nextSceneId: 'poem_display_final', isGrowthMindset: false }
          ], 
          specialEffect: 'gold_glow'
        },
        'poem_display_final': {
          id: 'poem_display_final',
          backgroundUrl: BG_POEM_SCROLL,
          characterId: CharacterId.Narrator,
          text: '„ÄäÈÄÅÂÖÉ‰∫å‰ΩøÂÆâË•ø„Äã\nÂîê¬∑ÁéãÁ∂≠\n\nÊ∏≠ÂüéÊúùÈõ®Êµ•ËºïÂ°µÔºå\nÂÆ¢ËàçÈùíÈùíÊü≥Ëâ≤Êñ∞„ÄÇ\nÂã∏ÂêõÊõ¥Áõ°‰∏ÄÊùØÈÖíÔºå\nË•øÂá∫ÈôΩÈóúÁÑ°ÊïÖ‰∫∫„ÄÇ',
          choices: [
            { id: 'goto_epilogue', text: 'ÈÄ≤ÂÖ•Áèæ‰ª£ÁØáÔºöÊùéÈáëÂ∞èÂ≠∏ÁöÑÁï¢Ê•≠Â≠£', nextSceneId: 'epilogue_start', isGrowthMindset: false }
          ],
          specialEffect: 'gold_glow'
        },
        'epilogue_start': {
          id: 'epilogue_start',
          backgroundUrl: BG_CLASSROOM,
          characterId: CharacterId.Narrator,
          text: 'ÊôÇÂÖâÈ£õÈÄùÔºåÁï´Èù¢Êº∏Êº∏Ê®°Á≥ä...\n\nÁï∂‰Ω†ÂÜçÊ¨°ÁùúÈñãÁúºÊôÇÔºå‰Ω†ÁôºÁèæËá™Â∑±Ê≠£ÂùêÂú®ÊùéÈáëÂ∞èÂ≠∏ÁöÑË™≤ÂÆ§Ë£°„ÄÇ\nÂâõÂâõÈÇ£Â†¥Âîê‰ª£ÁöÑÈÄÅÂà•Ôºå‰ºº‰πéÂè™ÊòØ‰∏ÄÂ†¥ÁîüÂãïÁöÑË™≤Â†ÇÈ´îÈ©ó„ÄÇ',
          choices: [
            { id: 'epi_look_around', text: 'ÁúãÂêëÊóÅÈÇäÁöÑÂêåÂ≠∏', nextSceneId: 'epilogue_dialogue_1', isGrowthMindset: false }
          ]
        },
        'epilogue_dialogue_1': {
          id: 'epilogue_dialogue_1',
          backgroundUrl: BG_CLASSROOM,
          characterId: CharacterId.XiaoMing,
          text: 'ÔºàÂ∞èÊòéË∂¥Âú®Ê°å‰∏äÔºåÁúãËëóÁ™óÂ§ñÔºåÈï∑Èï∑Âú∞ÂòÜ‰∫Ü‰∏ÄÂè£Ê∞£Ôºâ\nÂîâ...',
          choices: [
            { id: 'epi_ask_why', text: 'Â∞èÊòéÔºå‰Ω†ÊÄéÈ∫º‰∫ÜÔºü', nextSceneId: 'epilogue_dialogue_2', isGrowthMindset: false }
          ]
        },
        'epilogue_dialogue_2': {
          id: 'epilogue_dialogue_2',
          backgroundUrl: BG_CLASSROOM,
          characterId: CharacterId.XiaoMing,
          text: 'ÂâõÊâçËÄÅÂ∏´Ë¨õ‰∫ÜÁéãÁ∂≠ÂíåÂÖÉ‰∫åÁöÑÊïÖ‰∫ãÔºåÂæàÊÑü‰∫∫ÔºåËÆìÊàëÊÉ≥Âà∞‰∫ÜÊàëÂÄë„ÄÇ\n\nÂø´Áï¢Ê•≠‰∫ÜÔºåÂ§ßÂÆ∂ÈÉΩÂàÜÊ¥æÂà∞‰∏çÂêåÁöÑ‰∏≠Â≠∏„ÄÇÊÉ≥Âà∞Ë¶ÅÂíåÂ•ΩÊúãÂèãÂàÜÈñãÔºåÂéª‰∏ÄÂÄãÂÆåÂÖ®ÈôåÁîüÁöÑÊñ∞Â≠∏Ê†°ÔºåÊàëÂ∞±Ë¶∫ÂæóÂ•ΩÂÆ≥ÊÄïÔºåÂ•ΩÊç®‰∏çÂæó„ÄÇ',
          choices: [
            { id: 'epi_comfort_intro', text: 'ÔºàÈÅãÁî®ÂâõÊâçÂ≠∏Âà∞ÁöÑÊàêÈï∑ÊÄùÁ∂≠ÂÆâÊÖ∞‰ªñÔºâ', nextSceneId: 'epilogue_core_choice', isGrowthMindset: false }
          ]
        },
        'epilogue_core_choice': {
          id: 'epilogue_core_choice',
          backgroundUrl: BG_CLASSROOM,
          characterId: CharacterId.Player,
          text: 'ÁúãËëóÁÑ¶ÊÖÆÁöÑÂ∞èÊòéÔºå‰Ω†ÊúÉÊÄéÈ∫ºÂÆâÊÖ∞‰ªñÔºü',
          choices: [
            { 
              id: 'epi_fixed', 
              text: 'ÊòØÂïäÔºåÂàÜÈñãÁúüÁöÑÂæàÈõ£ÈÅé„ÄÇ‰∏ä‰∫Ü‰∏≠Â≠∏Â§ßÂÆ∂ÈÉΩÊúÉËÆäÔºå‰ª•ÂæåËÇØÂÆöÊúÉÂæàÂ≠§ÂñÆÁöÑ„ÄÇ', 
              nextSceneId: 'epilogue_bad', 
              isGrowthMindset: false 
            },
            { 
              id: 'epi_growth', 
              text: 'Âà•ÊÄïÔºÅÂ∞±ÂÉèÁéãÁ∂≠Â∞çÂÖÉ‰∫åÈÇ£Ê®£ÔºåÈõñÁÑ∂ÊàëÂÄë‰∏çÂú®Âêå‰∏ÄÈñìÂ≠∏Ê†°Ôºå‰ΩÜÂèãË™º‰∏çÊúÉËÆäÔºÅÊñ∞Â≠∏Ê†°‰πüÊòØÂÉèÂÆâË•ø‰∏ÄÊ®£ÂÖÖÊªøÊåëÊà∞ÁöÑÊñ∞ÈñãÂßãÂïäÔºÅ', 
              nextSceneId: 'epilogue_good', 
              isGrowthMindset: true 
            }
          ]
        },
        'epilogue_bad': {
          id: 'epilogue_bad',
          backgroundUrl: BG_CLASSROOM,
          characterId: CharacterId.XiaoMing,
          text: '‰Ω†Ë™™ÂæóÂ∞ç... ÂîâÔºåÊàëÁúü‰∏çÊÉ≥Áï¢Ê•≠„ÄÇ\n\nÔºàÂ∞èÊòéÁöÑÂøÉÊÉÖ‰æùÁÑ∂Âæà‰ΩéËêΩÔºåÁï¢Ê•≠ÁöÑÊ∞£Ê∞õËÆäÂæóÊõ¥Âä†Ê≤àÈáç‰∫Ü„ÄÇÔºâ',
          choices: [
            { id: 'epi_retry', text: 'ÈáçÊñ∞ÈºìÂãµ‰ªñ', nextSceneId: 'epilogue_core_choice', isGrowthMindset: false }
          ],
          specialEffect: 'fade_black'
        },
        'epilogue_good': {
          id: 'epilogue_good',
          backgroundUrl: BG_CLASSROOM,
          characterId: CharacterId.XiaoMing,
          text: 'ÔºàÂ∞èÊòéÊä¨Ëµ∑È†≠ÔºåÁúºÁùõ‰∫Æ‰∫ÜËµ∑‰æÜÔºâ\n‰Ω†Ë™™ÂæóÂ∞çÔºÅÁéãÁ∂≠‰ªñÂÄëÈöîËëóÊ≤ôÊº†ÈÉΩËÉΩÂÅöÊúãÂèãÔºåÊàëÂÄëÁèæÂú®ÈÇÑÊúâÊâãÊ©üÂë¢ÔºÅ\n\nË¨ùË¨ù‰Ω†ÔºåÊàëÁèæÂú®Ë¶∫ÂæóÂéªÊñ∞‰∏≠Â≠∏‰πüÊ≤íÈÇ£È∫ºÂèØÊÄï‰∫ÜÔºåÈÇ£ÊòØÊàëÂª∫Á´ãÊñ∞„ÄåÂäüÊ•≠ÁöÑÂú∞ÊñπÔºÅ',
          choices: [
            { id: 'the_end', text: '„ÄêÂÖ®ÂäáÁµÇ„ÄëÈáçÊñ∞ÈñãÂßã', nextSceneId: 'start', isGrowthMindset: false }
          ],
          specialEffect: 'gold_glow'
        }
      };

      // ==========================================
      // COMPONENT: GameScene
      // ==========================================
      const GameScene = ({ backgroundUrl, activeCharacterId, specialEffect }) => {
        const activeCharacter = activeCharacterId ? CHARACTERS[activeCharacterId] : undefined;
        // Logic: Show avatar if it's not the Narrator and not Wang Wei (First Person View), OR if it's Xiao Ming
        const shouldShowAvatar = activeCharacter && activeCharacterId !== CharacterId.Narrator && activeCharacterId !== CharacterId.WangWei;

        return (
          <div className="absolute inset-0 w-full h-full overflow-hidden bg-black">
            {/* Background Layer */}
            <div 
              className="absolute inset-0 w-full h-full bg-cover bg-center transition-all duration-1000 ease-in-out transform scale-105"
              style={{ backgroundImage: `url(${backgroundUrl})` }}
            >
              <div className="absolute inset-0 bg-black/40" />
            </div>

            {/* Special Effects */}
            {specialEffect === 'rain' && (
              <div className="absolute inset-0 pointer-events-none bg-[url('https://media.giphy.com/media/t7Qb8655Z1VfBGr5XB/giphy.gif')] opacity-30 bg-cover mix-blend-screen z-20" />
            )}
            
            {specialEffect === 'gold_glow' && (
              <div className="absolute inset-0 pointer-events-none animate-pulse bg-yellow-500/10 z-20" />
            )}

            {/* Character Layer */}
            {shouldShowAvatar && activeCharacter.avatarUrl && (
              <div className="absolute bottom-0 left-1/2 transform -translate-x-1/2 z-10 flex items-end justify-center h-full pb-[180px] pointer-events-none transition-opacity duration-500">
                <img 
                  src={activeCharacter.avatarUrl} 
                  alt={activeCharacter.name} 
                  className="max-h-[70vh] w-auto object-contain drop-shadow-[0_0_15px_rgba(0,0,0,0.8)] filter brightness-90"
                />
              </div>
            )}
          </div>
        );
      };

      // ==========================================
      // COMPONENT: DialogueBox
      // ==========================================
      const DialogueBox = ({ characterId, text, choices, onOptionSelected }) => {
        const [displayedText, setDisplayedText] = useState('');
        const [showOptions, setShowOptions] = useState(false);
        const speakerName = characterId ? CHARACTERS[characterId].name : '';
        const isNarrator = characterId === CharacterId.Narrator;
        
        const textContainerRef = useRef(null);
        const intervalRef = useRef(null);

        useEffect(() => {
          setDisplayedText('');
          setShowOptions(false);
          if (intervalRef.current) clearInterval(intervalRef.current);
          
          let currentIndex = 0;
          const fullText = text || '';
          const typingSpeed = 120; 
          
          intervalRef.current = setInterval(() => {
            currentIndex++;
            setDisplayedText(fullText.slice(0, currentIndex));
            
            if (currentIndex >= fullText.length) {
              if (intervalRef.current) clearInterval(intervalRef.current);
              setTimeout(() => {
                  setShowOptions(true);
              }, 500);
            }
          }, typingSpeed);

          return () => {
            if (intervalRef.current) clearInterval(intervalRef.current);
          };
        }, [text]);

        // Spacebar listener
        useEffect(() => {
          const handleKeyDown = (e) => {
            if (e.code === 'Space') {
              if (!showOptions) {
                if (intervalRef.current) clearInterval(intervalRef.current);
                setDisplayedText(text);
                setShowOptions(true);
              }
            }
          };
          window.addEventListener('keydown', handleKeyDown);
          return () => window.removeEventListener('keydown', handleKeyDown);
        }, [showOptions, text]);

        useEffect(() => {
          if (textContainerRef.current) {
              textContainerRef.current.scrollTop = textContainerRef.current.scrollHeight;
          }
        }, [displayedText]);

        const isPoem = text.includes('„ÄäÈÄÅÂÖÉ‰∫å‰ΩøÂÆâË•ø„Äã');

        return (
          <div className="absolute bottom-0 w-full p-4 z-30 flex justify-center">
            <div className={`w-full max-w-4xl bg-stone-900/95 border-t-4 border-b-4 border-yellow-700/80 rounded-md shadow-2xl p-6 md:p-8 min-h-[250px] max-h-[60vh] relative flex flex-col justify-between ${isPoem ? 'items-center text-center' : ''}`}>
              
              {!isNarrator && speakerName && (
                <div className="absolute -top-5 left-8 bg-stone-200 text-stone-900 px-6 py-1 text-xl font-bold border-2 border-stone-800 shadow-md transform -skew-x-12 z-40">
                   <span className="block transform skew-x-12">{speakerName}</span>
                </div>
              )}

              <div 
                  ref={textContainerRef}
                  className="flex-grow overflow-y-auto pr-2 custom-scrollbar"
              >
                <p className={`w-full text-xl md:text-2xl leading-loose tracking-wider font-serif whitespace-pre-line 
                  ${isNarrator ? 'text-yellow-100/90 font-medium text-center' : 'text-stone-100'}
                  ${isPoem ? 'text-3xl font-bold leading-relaxed text-yellow-200' : ''}
                `}>
                  {displayedText}
                  {!showOptions && <span className="animate-pulse inline-block ml-1 text-yellow-500">|</span>}
                </p>
              </div>

              {showOptions && choices && choices.length > 0 && (
                <div className={`mt-6 grid gap-3 animate-fade-in flex-shrink-0 ${isPoem ? 'w-full' : ''}`}>
                  {choices.map((choice) => (
                    <button
                      key={choice.id}
                      onClick={() => onOptionSelected(choice)}
                      className="w-full text-left bg-stone-800 hover:bg-yellow-900/40 border border-stone-600 hover:border-yellow-500 text-stone-200 py-3 px-5 rounded transition-all duration-200 group"
                    >
                      <span className="text-yellow-500 mr-2 group-hover:text-yellow-300">‚û§</span>
                      <span className="text-lg md:text-xl">{choice.text}</span>
                    </button>
                  ))}
                </div>
              )}
            </div>
          </div>
        );
      };

      // ==========================================
      // COMPONENT: App
      // ==========================================
      const App = () => {
        const [gameState, setGameState] = useState({
          currentSceneId: 'start',
          growthScore: 0,
          history: [],
          showFeedback: false,
          isThinking: false
        });
        
        const currentScene = STORY_SCRIPT[gameState.currentSceneId];

        const handleChoiceSelect = (choice) => {
          const newScore = choice.isGrowthMindset ? gameState.growthScore + 1 : gameState.growthScore;
          const showFeedback = choice.isGrowthMindset;

          setGameState(prev => ({
            ...prev,
            currentSceneId: choice.nextSceneId,
            growthScore: newScore,
            history: [...prev.history, prev.currentSceneId],
            showFeedback: showFeedback
          }));
        };

        useEffect(() => {
          if (gameState.showFeedback) {
            const timer = setTimeout(() => {
              setGameState(prev => ({ ...prev, showFeedback: false }));
            }, 3000);
            return () => clearTimeout(timer);
          }
        }, [gameState.showFeedback]);

        if (!currentScene) return <div className="text-white">Error: Scene not found</div>;

        return (
          <div className="relative w-screen h-screen bg-black overflow-hidden font-serif select-none">
            <GameScene 
              backgroundUrl={currentScene.backgroundUrl}
              activeCharacterId={currentScene.characterId}
              specialEffect={currentScene.specialEffect}
            />

            {gameState.showFeedback && (
              <div className="absolute top-1/4 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 animate-[bounce_1s_infinite]">
                <div className="bg-gradient-to-r from-yellow-600/80 to-yellow-800/80 text-white px-8 py-4 rounded-full border-2 border-yellow-300 shadow-[0_0_30px_rgba(234,179,8,0.6)] backdrop-blur-md">
                   <span className="text-2xl font-bold tracking-widest">‚ú® ÊàêÈï∑ÂÄº +1</span>
                </div>
              </div>
            )}

             <DialogueBox 
                key={currentScene.id} 
                characterId={currentScene.characterId}
                text={currentScene.text}
                choices={currentScene.choices}
                onOptionSelected={handleChoiceSelect}
             />
            
            <div className="absolute top-4 right-4 z-40 flex items-center gap-2 opacity-70 hover:opacity-100 transition-opacity">
                <div className="w-3 h-3 rounded-full bg-yellow-500"></div>
                <span className="text-stone-300 text-sm">ÊàêÈï∑ÂÄº: {gameState.growthScore}</span>
            </div>
          </div>
        );
      };

      // Mount
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>